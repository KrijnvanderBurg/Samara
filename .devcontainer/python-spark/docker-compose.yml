services:
    devcontainer:
        platform: linux/amd64
        build:
            context: .
            dockerfile: Dockerfile
            args:
                VARIANT: ubuntu-24.04
            target: base
        volumes:
            - ../../:/workspace:cached
            - devcontainer-bashhistory:/commandhistory
            - poetry-cache:/home/vscode/.cache/pypoetry
        command: sleep infinity

    jaeger:
        image: jaegertracing/all-in-one:latest
        platform: linux/amd64
        ports:
            - "16686:16686"  # Jaeger UI
            - "4317:4317"    # OTLP gRPC receiver
            - "4318:4318"    # OTLP HTTP receiver
        environment:
            - COLLECTOR_OTLP_ENABLED=true
            - LOG_LEVEL=info
        networks:
            - default

    prometheus:
        image: prom/prometheus:latest
        platform: linux/amd64
        ports:
            - "9090:9090"    # Prometheus UI
        volumes:
            - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus-storage:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.enable-lifecycle'
            - '--enable-feature=otlp-write-receiver'
        networks:
            - default

    grafana:
        image: grafana/grafana:latest
        platform: linux/amd64
        ports:
            - "3000:3000"    # Grafana UI
        environment:
            - GF_AUTH_ANONYMOUS_ENABLED=true
            - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
            - GF_AUTH_DISABLE_LOGIN_FORM=true
            - GF_SECURITY_ALLOW_EMBEDDING=true
        volumes:
            - grafana-storage:/var/lib/grafana
            - ./grafana/provisioning:/etc/grafana/provisioning
        depends_on:
            - jaeger
            - prometheus
        networks:
            - default

volumes:
    devcontainer-bashhistory:
    poetry-cache:
    grafana-storage:
    prometheus-storage:
